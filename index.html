<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#171c1b">
    <title>ODIN Common Operational Picture</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* =========================================================================
           STYLE GUIDE: DIY Common Operational Picture
           -------------------------------------------------------------------------
           This CSS provides the high-contrast, "command center" aesthetic.
           The map is inverted and heavily filtered (grayscale, high contrast).
        ========================================================================= */

        /* --- CORE RESET & LAYOUT --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            height: 100dvh;
            background: #171c1b; 
            font-family: 'Rajdhani', sans-serif;
            color: #d1d4d3; 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 0;
        }
        
        /* Map Tile Filter: Invert and desaturate the base OpenStreetMap tiles */
        .map-tiles {
            filter: invert(100%) grayscale(90%) hue-rotate(130deg) brightness(90%) contrast(130%);
        }
        
        /* Radar Overlay Filter: Ensures weather radar pops against the dark map */
        .radar-tiles {
            filter: blur(0.5px) contrast(1.2) saturate(1.2);
            image-rendering: optimizeQuality;
        }

        /* --- HEADER & CONTROLS --- */
        .header-info {
            position: fixed; top: 16px; left: 16px; z-index: 1000;
        }

        .mission-id {
            font-family: 'Share Tech Mono', monospace; font-size: 9px; color: rgba(209, 212, 211, 0.6); letter-spacing: 1.5px; margin-bottom: 2px;
        }

        .location-title {
            font-family: 'Rajdhani', sans-serif; font-size: 22px; font-weight: 700; color: #ffffff; letter-spacing: 2px; text-transform: uppercase;
            text-shadow: 0 0 20px rgba(0, 163, 110, 0.5); /* Green shadow for dramatic effect */
        }

        .header-controls {
            position: fixed; top: 16px; right: 16px; z-index: 1000; display: flex; align-items: center; gap: 12px;
        }

        .location-badge {
            background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(0, 163, 110, 0.3); padding: 6px 16px; display: flex; align-items: center; gap: 8px;
            clip-path: polygon(6px 0, 100% 0, 100% 100%, 0 100%, 0 6px); /* Beveled corner top-left */
        }

        .location-icon {
            width: 6px; height: 6px; background: #00a36e; clip-path: polygon(50% 0%, 100% 100%, 0% 100%);
            animation: pulse-location 2s ease-in-out infinite;
        }
        @keyframes pulse-location { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }

        .location-selector {
            background: rgba(23, 28, 27, 0.95); border: none; color: #00a36e; font-family: 'Share Tech Mono', monospace; font-size: 13px; font-weight: 600;
            letter-spacing: 2px; cursor: pointer; outline: none; text-transform: uppercase; padding: 0; margin: 0; min-width: 45px;
            -webkit-appearance: none; appearance: none;
        }

        .radar-control {
            background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(209, 212, 211, 0.1); padding: 6px 12px; font-family: 'Share Tech Mono', monospace;
            font-size: 11px; color: rgba(209, 212, 211, 0.6); letter-spacing: 1px; cursor: pointer;
            clip-path: polygon(4px 0, 100% 0, 100% 100%, 0 100%, 0 4px); transition: all 0.2s ease;
        }
        .radar-control:hover { border-color: #00a36e; color: #ffffff; }
        .radar-control.active {
            border-color: #00a36e; color: #00a36e; background: rgba(23, 28, 27, 0.95);
            box-shadow: 0 0 15px rgba(0, 163, 110, 0.2); text-shadow: 0 0 5px rgba(0, 163, 110, 0.5);
        }

        .time-display {
            background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(209, 212, 211, 0.1); padding: 6px 12px;
            font-family: 'Share Tech Mono', monospace; font-size: 11px; color: rgba(209, 212, 211, 0.6); letter-spacing: 1px;
            clip-path: polygon(0 0, calc(100% - 6px) 0, 100% 6px, 100% 100%, 0 100%);
        }

        /* --- LEFT SIDEBAR (METRICS) --- */
        .metrics-panel { position: fixed; left: 16px; top: 80px; z-index: 900; width: 160px; }
        .metric-block {
            background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(209, 212, 211, 0.1); margin-bottom: 2px; padding: 12px; position: relative;
            clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 0 100%);
        }
        .metric-block::before { content: ''; position: absolute; top: 0; right: 0; width: 10px; height: 10px; border-top: 1px solid rgba(209, 212, 211, 0.1); border-right: 1px solid rgba(209, 212, 211, 0.1); }
        .metric-label { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: rgba(209, 212, 211, 0.6); letter-spacing: 1px; margin-bottom: 6px; text-transform: uppercase; }
        .metric-value { font-family: 'Rajdhani', sans-serif; font-size: 32px; font-weight: 700; color: #ffffff; line-height: 1; letter-spacing: 1px; }
        .metric-subtext { font-family: 'Share Tech Mono', monospace; font-size: 8px; color: rgba(209, 212, 211, 0.3); margin-top: 4px; letter-spacing: 0.5px; }

        /* Semantic colors for data values */
        .metric-block.aircraft .metric-value { color: #00d9ff; text-shadow: 0 0 10px rgba(0, 217, 255, 0.3); } /* Blue */
        .metric-block.vessels .metric-value { color: #00a36e; text-shadow: 0 0 10px rgba(0, 163, 110, 0.3); } /* Green */
        .metric-block.incidents .metric-value { color: #ff0064; text-shadow: 0 0 10px rgba(255, 0, 100, 0.3); } /* Red/Pink */

        /* --- RIGHT SIDEBAR (LEGEND) --- */
        .legend-panel {
            position: fixed; right: 16px; top: 80px; z-index: 900; width: 180px; background: rgba(23, 28, 27, 0.95);
            border: 1px solid rgba(209, 212, 211, 0.1); clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }
        .legend-panel::before { content: ''; position: absolute; top: 0; left: 0; width: 10px; height: 10px; border-top: 1px solid rgba(209, 212, 211, 0.1); border-left: 1px solid rgba(209, 212, 211, 0.1); }
        .legend-header { padding: 12px; border-bottom: 1px solid rgba(209, 212, 211, 0.1); font-family: 'Share Tech Mono', monospace; font-size: 9px; color: rgba(209, 212, 211, 0.5); letter-spacing: 1.5px; text-transform: uppercase; }
        .legend-content { padding: 12px; }
        .legend-section { margin-bottom: 20px; }
        .legend-section:last-child { margin-bottom: 0; }
        .legend-section-title {
            font-family: 'Share Tech Mono', monospace; font-size: 9px; color: rgba(209, 212, 211, 0.4); letter-spacing: 1.5px;
            margin-bottom: 10px; text-transform: uppercase; padding-left: 8px; border-left: 2px solid rgba(0, 163, 110, 0.3);
        }
        .legend-item { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; font-size: 12px; color: rgba(209, 212, 211, 0.6); font-weight: 500; }
        .legend-icon { width: 20px; height: 20px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .legend-icon svg { filter: drop-shadow(0 0 1px currentColor); }

        /* --- BOTTOM INFO PANEL --- */
        .info-panel {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 900;
            background: rgba(23, 28, 27, 0.98); border: 1px solid rgba(0, 163, 110, 0.3); width: 600px;
            opacity: 0; pointer-events: none; transition: all 0.3s ease;
            clip-path: polygon(20px 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%, 0 20px);
        }
        .info-panel::before { content: ''; position: absolute; top: 0; left: 0; width: 20px; height: 20px; border-top: 1px solid rgba(0, 163, 110, 0.3); border-left: 1px solid rgba(0, 163, 110, 0.3); }
        .info-panel::after { content: ''; position: absolute; bottom: 0; right: 0; width: 20px; height: 20px; border-bottom: 1px solid rgba(0, 163, 110, 0.3); border-right: 1px solid rgba(0, 163, 110, 0.3); }
        .info-panel.visible { opacity: 1; pointer-events: all; }
        .info-header { padding: 20px 24px; border-bottom: 1px solid rgba(209, 212, 211, 0.1); }
        .info-title { font-family: 'Rajdhani', sans-serif; font-size: 24px; font-weight: 700; color: #ffffff; letter-spacing: 2px; margin-bottom: 4px; }
        .info-subtitle { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: rgba(209, 212, 211, 0.4); letter-spacing: 1.5px; text-transform: uppercase; }
        .info-stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 0; }
        .info-stats-2col { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0; }
        .info-stat { padding: 20px; text-align: center; border-right: 1px solid rgba(209, 212, 211, 0.05); border-bottom: 1px solid rgba(209, 212, 211, 0.05); }
        .info-stat:last-child { border-right: none; }
        .info-stat-value { font-family: 'Rajdhani', sans-serif; font-size: 28px; font-weight: 700; color: #00a36e; margin-bottom: 4px; text-shadow: 0 0 10px rgba(0, 163, 110, 0.3); }
        .info-stat-label { font-family: 'Share Tech Mono', monospace; font-size: 9px; color: rgba(209, 212, 211, 0.4); letter-spacing: 1.5px; text-transform: uppercase; }

        /* --- FOOTER CONTROLS --- */
        .audio-control {
            position: fixed; bottom: 20px; left: 20px; z-index: 900; background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(209, 212, 211, 0.1);
            padding: 12px 16px; display: flex; align-items: center; gap: 10px; cursor: pointer;
            clip-path: polygon(0 0, calc(100% - 10px) 0, 100% 10px, 100% 100%, 0 100%);
        }
        .audio-control::before { content: ''; position: absolute; top: 0; right: 0; width: 10px; height: 10px; border-top: 1px solid rgba(209, 212, 211, 0.1); border-right: 1px solid rgba(209, 212, 211, 0.1); }
        .audio-control:hover { border-color: rgba(0, 163, 110, 0.3); }
        .audio-control.playing { border-color: rgba(0, 163, 110, 0.6); background: rgba(23, 28, 27, 0.95); }
        .audio-control svg { width: 16px; height: 16px; fill: rgba(209, 212, 211, 0.6); }
        .audio-control.playing svg { fill: #00a36e; }
        .audio-text { font-family: 'Share Tech Mono', monospace; font-size: 11px; color: rgba(209, 212, 211, 0.6); letter-spacing: 1.5px; text-transform: uppercase; }
        .audio-control.playing .audio-text { color: #00a36e; }

        .connection-status {
            position: fixed; bottom: 20px; right: 20px; z-index: 900; background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(209, 212, 211, 0.1);
            padding: 12px 16px; display: flex; align-items: center; gap: 10px;
            clip-path: polygon(10px 0, 100% 0, 100% 100%, 0 100%, 0 10px);
        }
        .connection-status::before { content: ''; position: absolute; top: 0; left: 0; width: 10px; height: 10px; border-top: 1px solid rgba(209, 212, 211, 0.1); border-left: 1px solid rgba(209, 212, 211, 0.1); }
        .status-indicator { width: 8px; height: 8px; background: rgba(209, 212, 211, 0.3); clip-path: polygon(50% 0%, 100% 50%, 50% 100%, 0% 50%); }
        .status-indicator.connected { background: #00a36e; animation: pulse-status 2s ease-in-out infinite; }
        .status-indicator.connecting { background: #ffa500; }
        .status-indicator.disconnected { background: #ff0064; }
        @keyframes pulse-status { 0%, 100% { opacity: 1; } 50% { opacity: 0.3; } }
        .status-text { font-family: 'Share Tech Mono', monospace; font-size: 10px; color: rgba(209, 212, 211, 0.6); letter-spacing: 1.5px; text-transform: uppercase; }

        /* --- MARKER STYLING & LEAFLET OVERRIDES --- */
        .plane-marker, .vessel-marker { transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); }
        .plane-marker svg, .vessel-marker svg { filter: drop-shadow(0 0 1px currentColor); }
        .incident-marker { font-size: 12px; filter: drop-shadow(0 0 1px rgba(255, 0, 100, 0.8)); }
        /* Custom location markers are SVG + text label */
        .location-marker-wrapper { text-align: center; }
        .location-marker-svg .marker-outer-ring { fill: rgba(0, 163, 110, 0.1); stroke: rgba(0, 163, 110, 0.8); stroke-width: 2px; }
        .location-marker-svg .marker-inner-dot { fill: rgba(0, 163, 110, 0.9); }
        .location-marker-label {
            background: rgba(23, 28, 27, 0.95); border: 1px solid rgba(0, 163, 110, 0.5); color: #00a36e;
            font-family: 'Share Tech Mono', monospace; font-size: 11px; font-weight: 600; padding: 6px 12px;
            margin-top: 4px; white-space: nowrap; letter-spacing: 2px;
            clip-path: polygon(6px 0, 100% 0, 100% 100%, 0 100%, 0 6px);
        }
        .leaflet-control-attribution { background: rgba(23, 28, 27, 0.9) !important; color: rgba(209, 212, 211, 0.3) !important; font-size: 9px !important; padding: 4px 8px !important; border: 1px solid rgba(209, 212, 211, 0.1) !important; }
        .leaflet-control-attribution a { color: rgba(0, 163, 110, 0.6) !important; }

        /* --- MOBILE RESPONSIVE --- */
        @media (max-width: 768px) {
            .header-info { top: 12px; left: 12px; }
            .mission-id { font-size: 8px; }
            .location-title { font-size: 18px; }
            .header-controls { top: 12px; right: 12px; gap: 8px; }
            .time-display, .radar-control { padding: 5px 8px; font-size: 10px; }
            .metrics-panel { left: 12px; top: 65px; width: 140px; }
            .metric-block { padding: 10px; }
            .metric-value { font-size: 28px; }
            .legend-panel { display: none; }
            .legend-header { padding: 10px; font-size: 8px; }
            .info-panel { bottom: 12px; left: 12px; right: 12px; width: auto; transform: none; }
            .audio-control, .connection-status { bottom: 12px; padding: 10px 14px; }
            .audio-control { left: 12px; }
            .connection-status { right: 12px; }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="header-info">
        <div class="mission-id">OPS-LIVE-MONITOR</div>
        <div class="location-title" id="location-title">SEATTLE</div>
    </div>

    <div class="header-controls">
        <div class="location-badge">
            <div class="location-icon"></div>
            <select id="location-selector" class="location-selector">
                <option value="JFK">JFK</option>
                <option value="SEA" selected>SEA</option>
                <option value="DC">DC</option>
                <option value="MIA">MIA</option>
                <option value="DEN">DEN</option>
                <option value="ORD">ORD</option>
                <option value="LAX">LAX</option>
            </select>
        </div>
        
        <div id="radar-control" class="radar-control active">RADAR: ON</div>
        
        <div class="time-display" id="current-time">00:00:00</div>
    </div>

    <div class="metrics-panel">
        <div class="metric-block aircraft">
            <div class="metric-label">AIRCRAFT</div>
            <div class="metric-value" id="aircraft-count">0</div>
            <div class="metric-subtext">ACTIVE TRACKING</div>
        </div>
        <div class="metric-block vessels">
            <div class="metric-label">VESSELS</div>
            <div class="metric-value" id="vessel-count">0</div>
            <div class="metric-subtext">MONITORED</div>
        </div>
        <div class="metric-block incidents">
            <div class="metric-label">INCIDENTS</div>
            <div class="metric-value" id="incident-count">0</div>
            <div class="metric-subtext">LAST 3 HOURS</div>
        </div>
    </div>

    <div class="legend-panel">
        <div class="legend-header">LEGEND / CLASSIFICATIONS</div>
        <div class="legend-content">
            <div class="legend-section">
                <div class="legend-section-title">AIRCRAFT</div>
                <div class="legend-item">
                    <div class="legend-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#00d9ff" d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/></svg></div>
                    <span>COMMERCIAL</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#00ff88" d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/></svg></div>
                    <span>GENERAL AVN</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#ff0064" d="M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"/></svg></div>
                    <span>MILITARY</span>
                </div>
            </div>

            <div class="legend-section">
                <div class="legend-section-title">VESSELS</div>
                <div class="legend-item">
                    <div class="legend-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#00d9ff" d="M12 4 L8 8 L8 19 L16 19 L16 8 Z"/></svg></div>
                    <span>CARGO</span>
                </div>
                <div class="legend-item">
                    <div class="legend-icon"><svg width="20" height="20" viewBox="0 0 24 24"><path fill="#00ff88" d="M12 4 L8 8 L8 19 L16 19 L16 8 Z"/></svg></div>
                    <span>PASSENGER</span>
                </div>
            </div>

            <div class="legend-section">
                <div class="legend-section-title">EMERGENCY</div>
                <div class="legend-item">
                    <div class="legend-icon">ðŸ”¥</div>
                    <span>FIRE / EMS</span>
                </div>
            </div>
        </div>
    </div>

    <div id="info-panel" class="info-panel">
        <div id="aircraft-info" style="display: none;">
            <div class="info-header">
                <div class="info-title" id="ac-callsign"></div>
                <div class="info-subtitle" id="ac-type"></div>
            </div>
            <div class="info-stats">
                <div class="info-stat">
                    <div class="info-stat-value" id="ac-alt"></div>
                    <div class="info-stat-label">ALTITUDE</div>
                </div>
                <div class="info-stat">
                    <div class="info-stat-value" id="ac-spd"></div>
                    <div class="info-stat-label">SPEED</div>
                </div>
                <div class="info-stat">
                    <div class="info-stat-value" id="ac-stat"></div>
                    <div class="info-stat-label">STATUS</div>
                </div>
            </div>
        </div>

        <div id="vessel-info" style="display: none;">
            <div class="info-header">
                <div class="info-title" id="vs-name"></div>
                <div class="info-subtitle" id="vs-type"></div>
            </div>
            <div class="info-stats">
                <div class="info-stat">
                    <div class="info-stat-value" id="vs-spd"></div>
                    <div class="info-stat-label">SPEED</div>
                </div>
                <div class="info-stat">
                    <div class="info-stat-value" id="vs-hdg"></div>
                    <div class="info-stat-label">HEADING</div>
                </div>
                <div class="info-stat">
                    <div class="info-stat-value" id="vs-dest"></div>
                    <div class="info-stat-label">DESTINATION</div>
                </div>
            </div>
        </div>

        <div id="incident-info" style="display: none;">
            <div class="info-header">
                <div class="info-title" id="inc-type"></div>
                <div class="info-subtitle" id="inc-addr"></div>
            </div>
            <div class="info-stats-2col">
                <div class="info-stat">
                    <div class="info-stat-value" id="inc-id"></div>
                    <div class="info-stat-label">ID</div>
                </div>
                <div class="info-stat">
                    <div class="info-stat-value" id="inc-time"></div>
                    <div class="info-stat-label">TIME</div>
                </div>
            </div>
        </div>
    </div>

    <div id="audio-control" class="audio-control">
        <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
        <span class="audio-text" id="audio-text">ATC OFFLINE</span>
    </div>

    <div class="connection-status">
        <div class="status-indicator connecting" id="status-indicator"></div>
        <span class="status-text" id="status-text">CONNECTING</span>
    </div>

    <audio id="audio" preload="none"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // =========================================================================
        // CONFIGURATION: Customize URLs, Locations, and Colors here.
        // =========================================================================
        const CONFIG = {
            URLS: {
                MAP: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                RADAR: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',
                SHIPS: 'wss://ports-production-8906.up.railway.app', // WebSocket proxy for AIS data
                SEATTLE_911: 'https://data.seattle.gov/resource/grwu-wqtk.json', // Only works for Seattle
                ADSB: (lat, lon) => `https://api.airplanes.live/v2/point/${lat}/${lon}/50` // Aircraft feed
            },
            PATHS: {
                PLANE: "M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z",
                SHIP: "M12 4 L8 8 L8 19 L16 19 L16 8 Z"
            },
            LOCATIONS: {
                JFK: { 
                    name: 'JFK', lat: 40.6413, lon: -73.7781, zoom: 11, audio: 'https://d.liveatc.net/kjfk9_s', 
                    bbox: [[40.4, -74.3], [40.9, -73.7]] // Ship Bounding Box
                },
                SEA: { 
                    name: 'SEA', lat: 47.4502, lon: -122.3088, viewLat: 47.6062, viewLon: -122.3321,
                    zoom: 10, audio: 'https://d.liveatc.net/ksea3_gnd', 
                    bbox: [[47.4, -122.5], [47.8, -122.2]] 
                },
                DC: { 
                    name: 'IAD/DCA', lat: 38.8977, lon: -77.0365, zoom: 10, audio: 'https://d.liveatc.net/kiad1_1', 
                    bbox: [[38.5, -77.5], [39.2, -76.3]] 
                },
                MIA: { 
                    name: 'MIA', lat: 25.7959, lon: -80.2870, zoom: 11, audio: 'https://d.liveatc.net/kmia3_gnd', 
                    bbox: [[25.7, -80.3], [25.9, -80.1]] 
                },
                DEN: { 
                    name: 'DEN', lat: 39.8561, lon: -104.6737, zoom: 11, audio: 'https://d.liveatc.net/kden1_6', 
                    bbox: [[39.8, -104.8], [40.0, -104.5]] // Landlocked, small BBox
                },
                ORD: { 
                    name: 'ORD', lat: 41.9742, lon: -87.9073, zoom: 11, audio: 'https://d.liveatc.net/kord1n2_app_133625', 
                    bbox: [[41.8, -87.6], [42.0, -87.5]] // Near Lake Michigan
                },
                LAX: { 
                    name: 'LAX', lat: 33.9416, lon: -118.4085, zoom: 11, audio: 'https://d.liveatc.net/klax4', 
                    bbox: [[33.7, -118.5], [34.0, -118.3]] // Near Port of LA
                }
            },
            COLORS: {
                COMM: '#00d9ff',    // Commercial Aircraft (Blue)
                GA: '#00ff88',      // General Aviation (Light Green)
                MIL: '#ff0064',     // Military (Hot Pink/Red)
                HELI: '#ffa500',    // Helicopters (Orange)
                OTHER: 'rgba(255, 255, 255, 0.3)', // Default/Unknown
                TUG: '#a855f7', 
                PILOT: '#ec4899'
            }
        };

        // =========================================================================
        // GLOBAL STATE & LAYERS
        // =========================================================================
        const state = {
            location: 'JFK',
            map: null,
            isRadarOn: true,       // <--- MODIFICATION 1: Set default state to true
            selectedItem: null, 
            isFollowing: false,
            socket: null,
            reconnectTimer: null,
            audioElement: document.getElementById('audio')
        };

        const layers = {
            base: null,
            radar: null,
            planes: { 
                markers: new Map(), // L.Marker objects
                trails: new Map(),  // Array of historic coordinates
                lines: new Map(),   // L.Polyline objects for trails
                data: new Map()     // Raw JSON data
            },
            vessels: { 
                markers: new Map(), 
                trails: new Map(), 
                lines: new Map(), 
                data: new Map() 
            },
            incidents: { 
                markers: new Map(), 
                data: new Map() 
            },
            overlays: [] // Stores airport markers (for DC/SEA)
        };

        // =========================================================================
        // INITIALIZATION & MAP SETUP
        // =========================================================================
        function init() {
            // Set initial UI state and map view
            document.getElementById('location-selector').value = state.location;
            updateLocationTitle();

            initMap();
            
            // MODIFICATION 3: Call initialization function after map is ready
            if (state.isRadarOn) {
                initializeRadarOn();
            }

            startTracking();
            setupEventListeners();
            
            // Start the clock and audio
            updateClock();
            setInterval(updateClock, 1000);
			autoStartAudio();
        }

        function initMap() {
            const loc = CONFIG.LOCATIONS[state.location];
            
            // Use viewLat/Lon if available for a better initial view
            const centerLat = loc.viewLat || loc.lat;
            const centerLon = loc.viewLon || loc.lon;

            state.map = L.map('map', {
                center: [centerLat, centerLon],
                zoom: loc.zoom,
                zoomControl: false, // Use custom zoom control placement
                attributionControl: true
            });
            
            // Add base map tiles (OpenStreetMap)
            layers.base = L.tileLayer(CONFIG.URLS.MAP, {
                attribution: 'Â© OpenStreetMap',
                maxZoom: 19,
                className: 'map-tiles'
            }).addTo(state.map);
            
            // Define radar layer but don't add it yet in initMap
            layers.radar = L.tileLayer(CONFIG.URLS.RADAR, { 
                opacity: 0.6,
                attribution: 'Weather Â© IEM',
                zIndex: 500,
                className: 'radar-tiles'
            });

            updateLocationMarker();
            L.control.zoom({ position: 'bottomright' }).addTo(state.map);
        }

        // MODIFICATION 2: New function to force radar on
        function initializeRadarOn() {
            layers.radar.addTo(state.map); 
            const btn = document.getElementById('radar-control');
            btn.classList.add('active');
            btn.textContent = "RADAR: ON";
        }


        function setupEventListeners() {
    document.getElementById('audio-control').addEventListener('click', toggleAudio);
    document.getElementById('radar-control').addEventListener('click', toggleRadar);
    document.getElementById('location-selector').addEventListener('change', (e) => changeLocation(e.target.value));
    
    // Handle map clicks
    state.map.on('click', (e) => {
        // 1. Ignore clicks on markers (let the marker's own handler work)
        if (e.originalEvent.target.closest('.leaflet-marker-icon')) return;
        
        // 2. Capture the state BEFORE we hide the box
        const wasFollowing = state.isFollowing || state.selectedItem;

        // 3. Now hide the box (which clears state.isFollowing)
        hideInfoBox();
        
        // 4. Use the CAPTURED variable to decide if we recenter
        if (wasFollowing) {
            recenterView();
        }

        // 5. AUDIO FIX: Attempt to unlock audio on this interaction
        // (Browsers block autoplay; this forces it on the first map interaction)
        if (state.audioElement.paused) {
            state.audioElement.muted = false;
            state.audioElement.play()
                .then(() => {
                    document.getElementById('audio-control').classList.add('playing');
                    document.getElementById('audio-text').textContent = 'ATC LIVE';
                })
                .catch((err) => { /* console.log('Audio waiting for interaction'); */ });
        }
    });
}

        // =========================================================================
        // LOCATION AND UI CONTROL
        // =========================================================================
        function changeLocation(code) {
            state.isFollowing = false;
            state.location = code;
            const loc = CONFIG.LOCATIONS[code];
            
            updateLocationTitle();
            
            // Set map view to the new location's center
            const centerLat = loc.viewLat || loc.lat;
            const centerLon = loc.viewLon || loc.lon;
            state.map.setView([centerLat, centerLon], loc.zoom);
            
            updateLocationMarker();
            
            // Clean up all existing markers and data from the old location
            clearMapData();
            hideInfoBox();
            
            // Update audio stream for the new location
            handleAudioChange(loc.audio);

            // Reconnect ship stream for the new location's bounding box
            if (state.socket && state.socket.readyState === WebSocket.OPEN) {
                subscribeToShips();
            }
            
            // If radar was on globally, keep it on for the new location
            if (state.isRadarOn) {
                layers.radar.addTo(state.map);
            }
            
            // Fetch incidents for the new location (will only show data for SEA)
            fetchFireIncidents();
        }

        function updateLocationMarker() {
            // Remove previous airport/location markers
            layers.overlays.forEach(l => state.map.removeLayer(l));
            layers.overlays = [];

            if (state.location !== 'DC') {
                // Standard single marker
                const loc = CONFIG.LOCATIONS[state.location];
                const icon = createLocationIcon(loc.name);
                layers.overlays.push(L.marker([loc.lat, loc.lon], { icon }).addTo(state.map));
            } else {
                // DC Special Logic: Show markers for both IAD and DCA
                addDCOverlays();
            }
        }

        function addDCOverlays() {
            layers.overlays.push(L.marker([38.9531, -77.4565], { icon: createLocationIcon('IAD') }).addTo(state.map));
            layers.overlays.push(L.marker([38.8521, -77.0377], { icon: createLocationIcon('DCA') }).addTo(state.map));
        }
        
        function clearMapData() {
            // Centralized function to clear all markers, polyline layers, and data maps
            const clearSet = (set) => {
                set.markers.forEach(m => state.map.removeLayer(m));
                set.markers.clear();
                
                if (set.lines) {
                    set.lines.forEach(l => state.map.removeLayer(l));
                    set.lines.clear();
                }
                
                if (set.trails) {
                    set.trails.clear();
                }
                
                set.data.clear();
            };

            clearSet(layers.planes);
            clearSet(layers.vessels);
            clearSet(layers.incidents);
            
            updateStats();
        }

        function recenterView() {
            const loc = CONFIG.LOCATIONS[state.location];
            // Use viewLat/Lon if available
            const centerLat = loc.viewLat || loc.lat;
            const centerLon = loc.viewLon || loc.lon;
            
            // Smoothly fly back to the default view for the current location
            state.map.flyTo([centerLat, centerLon], loc.zoom, { duration: 1 });
            hideInfoBox();
        }

        // =========================================================================
        // DATA FETCHING: AIRCRAFT (ADSB - POLLING)
        // =========================================================================
        async function fetchPlanes() {
            try {
                const loc = CONFIG.LOCATIONS[state.location];
                // Fetch aircraft data centered on the city location
                const res = await fetch(CONFIG.URLS.ADSB(loc.lat, loc.lon));
                const data = await res.json();
                
                if (!data.ac) return;
                
                const activeHexes = new Set();
                
                data.ac.forEach(ac => {
                    // Basic data validation: skip if no location or if aircraft is on the ground
                    if (!ac.lat || !ac.lon || ac.alt_baro < 100) return;
                    
                    activeHexes.add(ac.hex);
                    layers.planes.data.set(ac.hex, ac);
                    
                    // Trail management
                    if (!layers.planes.trails.has(ac.hex)) {
                        layers.planes.trails.set(ac.hex, []);
                    }
                    const trail = layers.planes.trails.get(ac.hex);
                    trail.push([ac.lat, ac.lon]);
                    if (trail.length > 200) trail.shift(); // Max trail length: 200 points

                    updatePlaneMarker(ac, trail);
                });

                // Cleanup: Remove markers for planes no longer in the feed (flew away)
                layers.planes.markers.forEach((_, hex) => {
                    if (!activeHexes.has(hex)) {
                        state.map.removeLayer(layers.planes.markers.get(hex));
                        layers.planes.markers.delete(hex);
                        
                        if (layers.planes.lines.has(hex)) {
                            state.map.removeLayer(layers.planes.lines.get(hex));
                            layers.planes.lines.delete(hex);
                        }
                        layers.planes.trails.delete(hex);
                    }
                });
                
                updateStats();
            } catch (e) {
                console.error("ADSB Fetch Error", e);
            }
        }

        function updatePlaneMarker(ac, trail) {
            // Pan map if this aircraft is the selected item
            if (ac.hex === state.selectedItem && state.isFollowing) {
                state.map.panTo([ac.lat, ac.lon]);
            }

            // Determine aircraft type and color based on category code
            let color = CONFIG.COLORS.OTHER;
            let type = 'other';
            
            if (ac.category === 'A7') {
                type = 'heli'; color = CONFIG.COLORS.HELI;
            } else if (['A3','A4','A5'].includes(ac.category)) {
                type = 'comm'; color = CONFIG.COLORS.COMM; // Commercial
            } else if (['A1','A2'].includes(ac.category)) {
                type = 'ga'; color = CONFIG.COLORS.GA; // General Aviation
            } else if (ac.category === 'A6') {
                type = 'mil'; color = CONFIG.COLORS.MIL; // Military/Other special
            }

            const icon = createHudIcon(type, ac.track || 0, color, ac.category === 'A7');
            
            // Update or create the Leaflet marker
            if (layers.planes.markers.has(ac.hex)) {
                layers.planes.markers.get(ac.hex).setLatLng([ac.lat, ac.lon]).setIcon(icon);
            } else {
                const m = L.marker([ac.lat, ac.lon], { icon }).addTo(state.map);
                m.on('click', () => showInfo('plane', layers.planes.data.get(ac.hex)));
                layers.planes.markers.set(ac.hex, m);
            }

            // Update the polyline trail
            updateTrailLine(layers.planes.lines, ac.hex, trail, color);
        }

        // =========================================================================
        // DATA FETCHING: SHIPS (AIS - WEBSOCKET)
        // =========================================================================
        function connectWebSocket() {
            updateConnection('connecting');
            state.socket = new WebSocket(CONFIG.URLS.SHIPS);
            
            state.socket.onopen = () => {
                console.log('WS Connected');
                updateConnection('connected');
                setTimeout(subscribeToShips, 2000); // Subscribe after brief delay
            };
            
            state.socket.onmessage = (e) => {
                try {
                    const d = JSON.parse(e.data);
                    // Standard message handler
                    if (d.type !== 'status') {
                        processAIS(d);
                    }
                } catch(err) {}
            };
            
            state.socket.onclose = () => {
                updateConnection('disconnected');
                // Auto-reconnect after 5 seconds
                if (state.reconnectTimer) clearTimeout(state.reconnectTimer);
                state.reconnectTimer = setTimeout(connectWebSocket, 5000);
            };
        }

        function subscribeToShips() {
            // Send the bounding box request to the WebSocket server
            if (state.socket?.readyState === WebSocket.OPEN) {
                state.socket.send(JSON.stringify({
                    action: 'subscribe',
                    BoundingBoxes: [CONFIG.LOCATIONS[state.location].bbox]
                }));
                console.log(`WS Subscribed to BBox for ${state.location}`);
            }
        }

        function processAIS(d) {
            const metadata = d.MetaData;
            if (!metadata?.MMSI) return;
            
            const mmsi = metadata.MMSI;
            let vessel = layers.vessels.data.get(mmsi) || {
                mmsi: mmsi,
                name: metadata.ShipName || `MMSI ${mmsi}`,
                typeInt: 0, speed: 0, heading: 0, lat: null, lon: null
            };

            // Update position data
            if (d.MessageType === 'PositionReport' && metadata.latitude) {
                vessel.lat = metadata.latitude;
                vessel.lon = metadata.longitude;
                vessel.speed = d.Message.PositionReport.Sog || 0;
                vessel.heading = d.Message.PositionReport.TrueHeading || 0;
                
                if (vessel.speed < 0.1) return; // Filter stationary ships for cleaner map
            // Update static data (name, type, destination)
            } else if (d.MessageType === 'ShipStaticData') {
                vessel.name = d.Message.ShipStaticData.Name || vessel.name;
                vessel.typeInt = d.Message.ShipStaticData.Type;
                vessel.dest = d.Message.ShipStaticData.Destination;
            }

            layers.vessels.data.set(mmsi, vessel);

            if (vessel.lat) {
                if (!layers.vessels.trails.has(mmsi)) { layers.vessels.trails.set(mmsi, []); }
                
                const trail = layers.vessels.trails.get(mmsi);
                trail.push([vessel.lat, vessel.lon]);
                if (trail.length > 100) trail.shift();
                
                updateVesselMarker(vessel, trail);
                updateStats();
            }
        }

        function updateVesselMarker(vessel, trail) {
            if (vessel.mmsi === state.selectedItem && state.isFollowing) {
                state.map.panTo([vessel.lat, vessel.lon]);
            }
            
            // Determine ship color/type
            let color = CONFIG.COLORS.OTHER;
            if (vessel.typeInt >= 70 && vessel.typeInt <= 79) color = CONFIG.COLORS.COMM;
            else if (vessel.typeInt >= 80) color = CONFIG.COLORS.MIL;
            else if (vessel.typeInt >= 60 && vessel.typeInt <= 69) color = CONFIG.COLORS.GA;
            
            const icon = createHudIcon('ship', vessel.heading, color, false, CONFIG.PATHS.SHIP);

            // Update or create the Leaflet marker
            if (layers.vessels.markers.has(vessel.mmsi)) {
                layers.vessels.markers.get(vessel.mmsi).setLatLng([vessel.lat, vessel.lon]).setIcon(icon);
            } else {
                const m = L.marker([vessel.lat, vessel.lon], { icon }).addTo(state.map);
                m.on('click', () => showInfo('vessel', layers.vessels.data.get(vessel.mmsi)));
                layers.vessels.markers.set(vessel.mmsi, m);
            }
            
            updateTrailLine(layers.vessels.lines, vessel.mmsi, trail, color);
        }

        // =========================================================================
        // DATA FETCHING: INCIDENTS (SEATTLE ONLY - POLLING)
        // =========================================================================
        async function fetchFireIncidents() {
            // Note: This API is specific to Seattle. It will return zero incidents for other locations.
            if (state.location !== 'SEA') {
                updateStats();
                return;
            }
            
            try {
                // Query incidents from the last 10 hours
                const time = new Date(Date.now() - 36000000).toISOString().split('.')[0];
                const res = await fetch(`${CONFIG.URLS.SEATTLE_911}?$where=datetime>'${time}'`);
                
                if (!res.ok) throw new Error("Failed to fetch 911 data");
                const data = await res.json();
                
                data.forEach(inc => {
                    if (!inc.latitude) return;
                    
                    layers.incidents.data.set(inc.incident_number, inc);
                    
                    if (!layers.incidents.markers.has(inc.incident_number)) {
                        // Use emoji for icon
                        const icon = L.divIcon({ 
                            className: 'marker-icon incident-marker', 
                            html: 'ðŸ”¥', 
                            iconSize: [24,24], 
                            iconAnchor: [12,12] 
                        });
                        
                        const m = L.marker([inc.latitude, inc.longitude], { icon }).addTo(state.map);
                        m.on('click', () => showInfo('incident', inc));
                        layers.incidents.markers.set(inc.incident_number, m);
                    }
                });
                updateStats();
            } catch(e) {
                console.error("Incident fetch error:", e);
            }
        }

        // =========================================================================
        // UI AND UTILITY FUNCTIONS
        // =========================================================================
        
        function createLocationIcon(label) {
            // Generates the custom glowing airport icon with text label
            return L.divIcon({
                className: '', // Essential to remove Leaflet's default white box
                html: `<div class="location-marker-wrapper">
                        <svg class="location-marker-svg" width="36" height="36" viewBox="0 0 36 36">
                            <circle class="marker-outer-ring" cx="18" cy="18" r="14"/>
                            <circle class="marker-inner-dot" cx="18" cy="18" r="5"/>
                        </svg>
                        <div class="location-marker-label">${label}</div>
                       </div>`,
                iconSize: [90, 70],
                iconAnchor: [45, 35]
            });
        }

        function createHudIcon(type, rotation, color, isHeli, path = CONFIG.PATHS.PLANE) {
            // Generates the SVG path icon for planes/ships, rotating it by its track/heading
            const html = isHeli // Helicopters are represented by text symbol
                ? `<span style="color:${color}; transform: rotate(${rotation}deg); display:inline-block; font-size:24px;">&infin;</span>`
                : `<svg width="24" height="24" viewBox="0 0 24 24" style="transform: rotate(${rotation}deg); filter: drop-shadow(0 0 1px ${color});"><path fill="${color}" d="${path}"/></svg>`;
            
            return L.divIcon({
                className: 'marker-icon', // Used for CSS transitions
                html: html,
                iconSize: [24, 24],
                iconAnchor: [12, 12]
            });
        }

        function updateTrailLine(lineMap, id, trail, color) {
            // Updates or creates the polyline trail
            if (trail.length < 2) return;
            
            if (lineMap.has(id)) {
                lineMap.get(id).setLatLngs(trail).setStyle({ color, opacity: 0.6, weight: 2 });
            } else {
                const line = L.polyline(trail, { color, opacity: 0.6, weight: 2 }).addTo(state.map);
                lineMap.set(id, line);
            }
        }

        // --- INFO WINDOW HANDLERS ---
        function showInfo(type, data) {
            state.selectedItem = data.hex || data.mmsi || data.incident_number;
            state.isFollowing = true;
            
            // Prepare UI by hiding all sections
            ['aircraft-info', 'vessel-info', 'incident-info'].forEach(id => document.getElementById(id).style.display = 'none');
            
            // Populate and show the correct panel
            if (type === 'plane') {
                setText('ac-callsign', data.flight?.trim() || data.hex);
                setText('ac-type', data.t || 'UNKNOWN');
                setText('ac-alt', (data.alt_baro||0).toLocaleString() + ' ft');
                setText('ac-spd', Math.round((data.gs||0)*1.15) + ' mph');
                
                const vRate = data.baro_rate || 0;
                setText('ac-stat', (vRate > 350 ? 'CLIMB' : vRate < -350 ? 'DESC' : 'LEVEL'));
                
                document.getElementById('aircraft-info').style.display = 'block';
                state.map.flyTo([data.lat, data.lon], 11, { duration: 0.8 });
            
            } else if (type === 'vessel') {
                setText('vs-name', data.name);
                setText('vs-type', data.typeInt ? 'TYPE ' + data.typeInt : 'VESSEL');
                setText('vs-spd', data.speed.toFixed(1) + ' kts');
                setText('vs-hdg', Math.round(data.heading) + 'Â°');
                setText('vs-dest', data.dest || 'N/A');
                
                document.getElementById('vessel-info').style.display = 'block';
                state.map.flyTo([data.lat, data.lon], 13, { duration: 0.8 });
            
            } else { // Incident
                setText('inc-type', data.type);
                setText('inc-addr', data.address);
                setText('inc-id', data.incident_number);
                setText('inc-time', new Date(data.datetime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
                
                document.getElementById('incident-info').style.display = 'block';
                state.map.flyTo([data.latitude, data.longitude], 15, { duration: 0.8 });
            }
            
            document.getElementById('info-panel').classList.add('visible');
        }

        function hideInfoBox() {
            // Resets state and hides the info panel
            state.isFollowing = false;
            state.selectedItem = null;
            document.getElementById('info-panel').classList.remove('visible');
        }
        
        // --- AUXILIARY UI HANDLERS ---
        function toggleRadar() {
            state.isRadarOn = !state.isRadarOn;
            const btn = document.getElementById('radar-control');
            
            if (state.isRadarOn) {
                layers.radar.addTo(state.map);
                btn.classList.add('active');
                btn.textContent = "RADAR: ON";
            } else {
                layers.radar.remove();
                btn.classList.remove('active');
                btn.textContent = "RADAR: OFF";
            }
        }

        function toggleAudio() {
            const ctrl = document.getElementById('audio-control');
            
            if (state.audioElement.paused) {
                state.audioElement.play();
                ctrl.classList.add('playing');
                document.getElementById('audio-text').textContent = 'ATC LIVE';
            } else {
                state.audioElement.pause();
                ctrl.classList.remove('playing');
                document.getElementById('audio-text').textContent = 'ATC OFFLINE';
            }
        }

        function handleAudioChange(url) {
            const wasPlaying = !state.audioElement.paused;
            state.audioElement.src = url;
            
            if (wasPlaying) {
                state.audioElement.play().catch(()=>{});
            } else {
                document.getElementById('audio-text').textContent = 'ATC OFFLINE';
                document.getElementById('audio-control').classList.remove('playing');
            }
        }

        function autoStartAudio() {
            state.audioElement.src = CONFIG.LOCATIONS[state.location].audio;
            state.audioElement.muted = true;
            
            state.audioElement.play().then(() => {
                setTimeout(() => { 
                    state.audioElement.muted = false;
                    document.getElementById('audio-text').textContent = 'ATC LIVE';
                }, 500);
                document.getElementById('audio-control').classList.add('playing');
            }).catch(() => {});
        }

        // --- STATS AND CLOCK ---
        function setText(id, txt) {
            document.getElementById(id).textContent = txt;
        }

        function updateStats() {
            setText('aircraft-count', layers.planes.data.size);
            setText('vessel-count', layers.vessels.data.size);
            // Incidents only available for Seattle in this configuration
            setText('incident-count', state.location === 'SEA' ? layers.incidents.data.size : 0);
        }

        function updateClock() {
            const d = new Date();
            const timeStr = `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
            setText('current-time', timeStr);
        }

        function pad(n) {
            return n.toString().padStart(2,'0');
        }

        function updateLocationTitle() {
            setText('location-title', CONFIG.LOCATIONS[state.location].name);
        }

        function updateConnection(status) {
            const ind = document.getElementById('status-indicator');
            ind.className = `status-indicator ${status}`;
            
            let text = 'OFFLINE';
            if (status === 'connected') text = 'FEED ONLINE';
            if (status === 'connecting') text = 'CONNECTING';
            
            setText('status-text', text);
        }

        function startTracking() {
            // Start polling for planes every 3 seconds
            fetchPlanes();
            setInterval(fetchPlanes, 3000);
            
            // Connect and subscribe to ship data via WebSocket
            connectWebSocket();
            
            // Start polling for fire incidents every 30 seconds
            fetchFireIncidents();
            setInterval(fetchFireIncidents, 30000);
        }

        // Kickoff the application
        init();
    </script>
</body>
</html>