<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0d1f19">
    <title>AIRPORT 2025 - FLIGHT OPS</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        :root {
            --g-accent-1: #a8c256; 
            --g-accent-2: #6b9b37; 
            --g-text-muted: #8ba876; 
            --g-text-main: #f1f8e9;  
            --g-bg-1: #4a7c59;
            --g-bg-2: #3d5e4a; 
            --g-bg-3: #2d4a3a;
            --g-bg-4: #1a3a2e; 
            --g-bg-5: #0d1f19; 
            --color-sky: #6C8075;
            --color-ground: #0d1f19;
            --color-panel-bg: #1a3a2e;      
            --color-panel-border: #3d5e4a;  
            --color-text-main: var(--g-text-main);     
            --color-text-muted: var(--g-text-muted);
            --color-highlight: var(--g-accent-1);         
            --color-comm: #a8c256; 
            --color-ga: #6b9b37;   
            --color-mil: #f1f8e9;  
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        html, body {
            height: 100vh; 
            height: 100dvh;
            background: var(--g-bg-5); 
            font-family: 'Inter', sans-serif; 
            color: var(--color-text-main); 
            overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        #map { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100vh; 
            z-index: 0; 
            background: var(--g-bg-5);
        }
        
        .map-tiles { 
            filter: grayscale(50%) invert(100%) sepia(50%) hue-rotate(70deg) saturate(80%) brightness(0.7) contrast(1.2);
        }

        .header-info { 
            position: fixed; 
            top: 16px; 
            left: 16px; 
            z-index: 1000; 
            pointer-events: none;
        }

        .mission-id { 
            font-family: 'Share Tech Mono', monospace; 
            font-size: 11px; 
            color: var(--g-accent-1); 
            letter-spacing: 1px; 
            margin-bottom: 4px; 
            background: rgba(13, 31, 25, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
            display: inline-block;
            border: 1px solid var(--g-bg-2);
        }

        .location-title {
            font-family: 'Inter', sans-serif; 
            font-size: 24px; 
            font-weight: 700; 
            color: var(--g-text-main); 
            letter-spacing: 0.5px; 
            text-transform: uppercase;
            text-shadow: 0 0 10px rgba(168, 194, 86, 0.3);
        }

        .header-controls { 
            position: fixed; 
            top: 16px; 
            right: 16px; 
            z-index: 1000; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
        }

        .panel-style {
            background: var(--color-panel-bg); 
            border: 1px solid var(--color-panel-border); 
            border-radius: 6px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }

        .location-badge {
            padding: 6px 12px; 
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        .recenter-btn {
            cursor: pointer;
            transition: all 0.2s ease;
            stroke: var(--g-text-muted);
        }
        .recenter-btn:hover { stroke: var(--g-accent-1); transform: scale(1.1); }
        .recenter-btn:active { transform: scale(0.95); }

        /* DROPDOWN */
        .custom-select-wrapper {
            position: relative;
            user-select: none;
            width: 150px; 
            font-family: 'Share Tech Mono', monospace;
        }
        .custom-select { position: relative; display: flex; flex-direction: column; }
        .custom-select__trigger {
            position: relative;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 700;
            color: var(--g-accent-1); 
            line-height: 20px;
            background: transparent;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        .custom-select__trigger:hover { text-shadow: 0 0 8px rgba(168, 194, 86, 0.6); }
        .arrow { position: relative; height: 10px; width: 10px; margin-left: 10px; }
        .arrow::after {
            content: ""; position: absolute; top: 3px;
            border: solid var(--g-text-muted); border-width: 0 2px 2px 0;
            padding: 3px; transform: rotate(45deg); transition: 0.2s;
        }
        .custom-select.open .arrow::after { transform: rotate(-135deg); border-color: var(--g-accent-1); }
        .custom-options {
            position: absolute; display: block; top: 100%; left: 0; right: 0;
            border: 1px solid var(--color-panel-border); border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.8); background: var(--g-bg-4); 
            transition: all 0.2s; opacity: 0; visibility: hidden;
            pointer-events: none; z-index: 2000; margin-top: 8px;
        }
        .custom-select.open .custom-options { opacity: 1; visibility: visible; pointer-events: all; }
        .custom-option {
            position: relative; display: block; padding: 8px 12px;
            font-size: 12px; font-weight: 500; color: var(--g-text-main); 
            cursor: pointer; transition: all 0.1s; border-bottom: 1px solid var(--g-bg-2); 
        }
        .custom-option:last-of-type { border-bottom: none; }
        .custom-option:hover, .custom-option.selected {
            background-color: var(--g-accent-1); color: var(--g-bg-5); font-weight: 700;
        }

        .control-btn {
            padding: 6px 12px; 
            font-family: 'Share Tech Mono', monospace;
            font-size: 11px; 
            color: var(--g-text-muted); 
            letter-spacing: 1px; 
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
        }
        .control-btn.active {
            border-color: var(--g-accent-1); 
            color: var(--g-bg-5); 
            background: var(--g-accent-1); 
            font-weight: bold;
        }

        .time-display {
            padding: 6px 12px;
            font-family: 'Share Tech Mono', monospace; 
            font-size: 12px; 
            color: var(--g-accent-1); 
            min-width: 80px;
            text-align: center;
        }

        .metrics-panel { 
            position: fixed; left: 16px; top: 80px; z-index: 900; 
            width: 140px; pointer-events: none; display: flex; flex-direction: column; gap: 8px;
        }
        .metric-block {
            background: rgba(26, 58, 46, 0.9); border-left: 4px solid var(--g-accent-1); 
            padding: 8px 12px; border-radius: 4px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .metric-label { 
            font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 600;
            color: var(--g-text-muted); margin-bottom: 2px; text-transform: uppercase;
        }
        .metric-value { 
            font-family: 'Share Tech Mono', monospace; font-size: 22px; font-weight: 500; color: var(--g-text-main); 
        }

        .legend-panel {
            position: fixed; bottom: 20px; right: 20px; z-index: 900;
            background: var(--color-panel-bg); border: 1px solid var(--color-panel-border);
            border-radius: 6px; padding: 12px; width: 160px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        .legend-header {
            font-size: 10px; color: var(--g-text-muted); margin-bottom: 8px; font-weight: 700; letter-spacing: 1px;
        }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; }
        .legend-icon { width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; margin-right: 8px; }
        .legend-item span { font-size: 11px; color: var(--g-text-main); }

        .info-panel {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            z-index: 900;
            background: rgba(13, 31, 25, 0.95); 
            border: 1px solid var(--g-bg-2); 
            width: 460px; 
            max-width: 95vw;
            height: 240px; 
            opacity: 0; 
            pointer-events: none; 
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            border-radius: 12px; 
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.6);
            backdrop-filter: blur(10px);
        }

        .info-panel.visible { 
            opacity: 1; 
            pointer-events: all; 
            transform: translateX(-50%) translateY(0);
        }
        
        .pfd-data-overlay {
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 16px 20px; display: flex; justify-content: space-between; 
            align-items: flex-start; z-index: 20; pointer-events: none;
        }
        
        .info-title { 
            font-family: 'Inter', sans-serif; font-size: 20px; font-weight: 700; color: var(--g-text-main); line-height: 1; padding: 2px;
        }
        .info-subtitle { 
            font-family: 'Share Tech Mono', monospace; font-size: 18px; font-weight: 700;
            color: var(--g-accent-1); letter-spacing: 1px; text-transform: uppercase; 
            margin-top: 2px; padding: 2px;        
        }
        .info-reg {
            font-family: 'Share Tech Mono', monospace; font-size: 14px; font-weight: 700;
            color: var(--g-text-muted); letter-spacing: 1px; text-transform: uppercase; margin-top: 2px; padding: 2px;
        }
        .pfd-heading-box { text-align: right; }
        .hdg-value { 
            font-family: 'Share Tech Mono', monospace; font-size: 24px; font-weight: 700; color: var(--g-text-main); line-height: 1; padding: 2px;
        }

        .info-stats-container {
            position: absolute; bottom: 0; width: 100%; background: var(--g-bg-4); 
            z-index: 20; border-top: 2px solid var(--g-bg-2);
        }
        .info-stats { display: grid; grid-template-columns: repeat(3, 1fr); }
        .info-stat { padding: 12px 0; text-align: center; border-right: 1px solid var(--g-bg-2); }
        .info-stat:last-child { border-right: none; }
        .info-stat-value { 
            font-family: 'Share Tech Mono', monospace; font-size: 22px; font-weight: 500; color: var(--g-text-main); margin-bottom: 2px; text-shadow: 0 0 5px rgba(168, 194, 86, 0.2);
        }
        .info-stat-label { 
            font-family: 'Inter', sans-serif; font-size: 9px; font-weight: 600; color: var(--g-text-muted); letter-spacing: 0.5px; text-transform: uppercase; 
        }

        #ahrs-full-display { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; overflow: hidden; background: var(--g-bg-5); }
        .ahrs-horizon-wrapper { width: 300%; height: 300%; position: absolute; top: -100%; left: -100%; will-change: transform; transition: transform 0.2s linear; }
        .ahrs-sky { width: 100%; height: 50%; background: var(--color-sky); position: absolute; top: 0; left: 0; }
        .ahrs-ground { width: 100%; height: 50%; background: var(--g-bg-5); position: absolute; top: 50%; left: 0; border-top: 2px solid var(--g-accent-1); }
        .ahrs-ladder { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 33.33%; height: 33.33%; opacity: 0.9; }
        .ahrs-crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 180px; height: 60px; z-index: 5; pointer-events: none; }

        .target-reticle-icon { 
            pointer-events: none; display: flex; align-items: center; justify-content: center; 
        }

        .reticle-ring {
            position: absolute; 
            width: 60px; height: 60px;
            border: 4px solid var(--g-accent-1); 
            border-radius: 50%;
            box-shadow: 0 0 15px var(--g-accent-1), inset 0 0 10px var(--g-accent-1);
            animation: pulse-ring 1.5s infinite;
        }

        @keyframes pulse-ring {
            0% { transform: scale(0.9); opacity: 0.6; }
            50% { transform: scale(1.0); opacity: 1; }
            100% { transform: scale(0.9); opacity: 0.6; }
        }

        .pfd-route-overlay {
            position: absolute; top: 16px; /* Compact */
            left: 0; width: 100%; display: flex; justify-content: center; pointer-events: none; z-index: 25;
        }
        .route-box {
            background-color: rgba(13, 31, 25, 0.4); border: 1px solid var(--g-bg-2);
            padding: 4px 12px; border-radius: 20px; display: flex; align-items: center; gap: 12px; backdrop-filter: blur(2px);
        }
        #ac-route-dep, #ac-route-arr {
            font-family: 'Share Tech Mono', monospace; font-size: 18px; font-weight: 700; color: var(--g-accent-1); text-shadow: 0 0 8px rgba(168, 194, 86, 0.4);
        }
        .route-arrow { font-size: 18px; color: var(--g-text-muted); }

        .audio-control { 
            position: fixed; bottom: 20px; left: 20px; z-index: 10; 
            background: var(--color-panel-bg); border: 1px solid var(--color-panel-border); 
            padding: 8px 12px; display: flex; align-items: center; gap: 8px; cursor: pointer; border-radius: 6px; 
            white-space: nowrap; min-width: 100px; box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .audio-control.playing svg { fill: var(--g-accent-1); } 
        .audio-control svg { fill: var(--g-text-muted); }

        /* MOBILE OPTIMIZATION */
        @media (max-width: 600px) {
            .legend-panel { display: none; }
            .time-display { display: none; }
            .mission-id { display: none; }
            .location-title { font-size: 18px; }
            
            .info-panel {
                bottom: 0; left: 0; width: 100%; max-width: 100%;
                border-radius: 16px 16px 0 0; transform: translateY(100%);
                border-left: none; border-right: none; border-bottom: none;
            }
            .info-panel.visible { transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="header-info">
        <div class="mission-id">LIVE OPERATIONS</div>
        <div class="location-title" id="location-title">SEATTLE</div>
    </div>

    <div class="header-controls">
        <div class="location-badge panel-style">
            <svg id="recenter-btn" class="recenter-btn" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke-width="2" title="Recenter Map"><circle cx="12" cy="12" r="10"></circle><circle cx="12" cy="12" r="2"></circle></svg>
            <div class="custom-select-wrapper">
                <div class="custom-select">
                    <div class="custom-select__trigger">
                        <span id="selected-text">JFK INT'L</span>
                        <div class="arrow"></div>
                    </div>
                    <div class="custom-options">
                        <span class="custom-option selected" data-value="JFK">JFK INT'L</span>
                        <span class="custom-option" data-value="SEA">SEATTLE-TAC</span>
                        <span class="custom-option" data-value="ATL">HARTSFIELD</span>
                        <span class="custom-option" data-value="DC">REAGAN/DULLES</span>
                        <span class="custom-option" data-value="MIA">MIAMI INT'L</span>
                        <span class="custom-option" data-value="DEN">DENVER INT'L</span>
                        <span class="custom-option" data-value="ORD">O'HARE INT'L</span>
                        <span class="custom-option" data-value="LAX">LOS ANGELES</span>
                    </div>
                </div>
            </div>
        </div>
        <div id="radar-control" class="control-btn panel-style active">RADAR: ON</div>
        <div class="time-display panel-style" id="current-time">00:00:00</div>
    </div>

    <div class="metrics-panel">
        <div class="metric-block aircraft">
            <div class="metric-label">AIR TRAFFIC</div>
            <div class="metric-value" id="aircraft-count">0</div>
        </div>
    </div>

    <div class="legend-panel">
        <div class="legend-header">LEGEND</div>
        <div class="legend-content">
            <div class="legend-item"><div class="legend-icon"><div style="width:8px;height:8px;background:#a8c256;border-radius:50%;box-shadow:0 0 2px #a8c256"></div></div><span>COMMERCIAL</span></div>
            <div class="legend-item"><div class="legend-icon"><div style="width:8px;height:8px;background:#6b9b37;border-radius:50%"></div></div><span>GENERAL AVN</span></div>
            <div class="legend-item"><div class="legend-icon"><div style="width:8px;height:8px;background:#f1f8e9;border-radius:50%"></div></div><span>MILITARY</span></div>
        </div>
    </div>

    <div id="info-panel" class="info-panel">
        <div id="aircraft-info" style="display: none; height: 100%;">
            <div id="ahrs-full-display">
                <div id="ahrs-horizon" class="ahrs-horizon-wrapper">
                    <div class="ahrs-sky"></div>
                    <div class="ahrs-ground"></div>
                    <svg class="ahrs-ladder" viewBox="0 0 400 200" preserveAspectRatio="none">
                        <line x1="100" y1="50" x2="300" y2="50" stroke="#a8c256" stroke-width="2" opacity="0.6" />
                        <text x="310" y="54" fill="#a8c256" font-family="Share Tech Mono" font-size="14" opacity="0.8">10</text>
                        <line x1="150" y1="75" x2="250" y2="75" stroke="#a8c256" stroke-width="2" opacity="0.6" />
                        <line x1="0" y1="100" x2="400" y2="100" stroke="#a8c256" stroke-width="3" /> 
                        <line x1="150" y1="125" x2="250" y2="125" stroke="#a8c256" stroke-width="2" opacity="0.6" />
                        <line x1="100" y1="150" x2="300" y2="150" stroke="#a8c256" stroke-width="2" opacity="0.6" />
                        <text x="310" y="154" fill="#a8c256" font-family="Share Tech Mono" font-size="14" opacity="0.8">10</text>
                    </svg>
                </div>
                <svg class="ahrs-crosshair" viewBox="0 0 200 50">
                    <path d="M30,25 L80,25 L80,35 L30,35 Z" fill="#0d1f19" stroke="#a8c256" stroke-width="2"/>
                    <rect x="95" y="20" width="10" height="10" fill="#0d1f19" stroke="#a8c256" stroke-width="2"/>
                    <path d="M120,25 L170,25 L170,35 L120,35 Z" fill="#0d1f19" stroke="#a8c256" stroke-width="2"/>
                </svg>
            </div>
            
            <div class="pfd-data-overlay">
                <div class="pfd-callsign-box">
                    <div class="info-title" id="ac-callsign"></div>
                    <div class="info-subtitle" id="ac-type"></div>
                    <div class="info-reg" id="ac-reg"></div>
                </div>
                <div class="pfd-heading-box">
                    <div><span class="hdg-label"></span><span class="hdg-value" id="ac-hdg-text">000°</span></div>
                </div>
            </div>
            <div class="pfd-route-overlay">
                <div class="route-box">
                    <span id="ac-route-dep">---</span>
                    <span class="route-arrow">➔</span>
                    <span id="ac-route-arr">---</span>
                </div>
            </div>
            <div class="info-stats-container">
                <div class="info-stats">
                    <div class="info-stat">
                        <div class="info-stat-value" id="ac-alt"></div>
                        <div class="info-stat-label">ALTITUDE</div>
                    </div>
                    <div class="info-stat">
                        <div class="info-stat-value" id="ac-spd"></div>
                        <div class="info-stat-label">GND SPEED</div>
                    </div>
                    <div class="info-stat">
                        <div class="info-stat-value" id="ac-stat"></div>
                        <div class="info-stat-label">FLIGHT PHASE</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="audio-control" class="audio-control">
        <svg width="16" height="16" viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg>
        <span class="audio-text" id="audio-text">ATC OFFLINE</span>
    </div>

    <audio id="audio" preload="none"></audio>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const CONFIG = {
            URLS: {
                MAP: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                RADAR: 'https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png',
                ADSB: (lat, lon) => `https://api.airplanes.live/v2/point/${lat}/${lon}/50`,
                AWS_PROXY: 'https://yd7ndqoiq5.execute-api.us-east-1.amazonaws.com/prod/'
            },
            PATHS: {
                PLANE: "M21,16v-2l-8-5V3.5C13,2.67,12.33,2,11.5,2S10,2.67,10,3.5V9l-8,5v2l8-2.5V19l-2,1.5V22l3.5-1l3.5,1v-1.5L13,19v-5.5L21,16z"
            },
            LOCATIONS: {
                JFK: { name: 'JFK', lat: 40.6413, lon: -73.7781, zoom: 11, audio: 'https://d.liveatc.net/kjfk9_s', bbox: [[40.4, -74.3], [40.9, -73.7]] },
                SEA: { name: 'SEA', lat: 47.4502, lon: -122.3088, viewLat: 47.6062, viewLon: -122.3321, zoom: 10, audio: 'https://d.liveatc.net/ksea3_gnd', bbox: [[47.4, -122.5], [47.8, -122.2]] },
                DC: { name: 'IAD/DCA', lat: 38.8977, lon: -77.0365, zoom: 10, audio: 'https://d.liveatc.net/kiad1_1', bbox: [[38.5, -77.5], [39.2, -76.3]] },
                ATL: { name: 'ATL', lat: 33.6407, lon: -84.4277, zoom: 11, audio: 'https://d.liveatc.net/katl_twr', bbox: [[33.5, -84.6], [33.8, -84.2]] },
                MIA: { name: 'MIA', lat: 25.7959, lon: -80.2870, zoom: 11, audio: 'https://d.liveatc.net/kmia3_gnd', bbox: [[25.7, -80.3], [25.9, -80.1]] },
                DEN: { name: 'DEN', lat: 39.8561, lon: -104.6737, zoom: 11, audio: 'https://d.liveatc.net/kden1_6', bbox: [[39.8, -104.8], [40.0, -104.5]] },
                ORD: { name: 'ORD', lat: 41.9742, lon: -87.9073, zoom: 11, audio: 'https://d.liveatc.net/kord1n2_app_133625', bbox: [[41.8, -87.6], [41.99, -87.5]] },
                LAX: { name: 'LAX', lat: 33.9416, lon: -118.4085, zoom: 11, audio: 'https://d.liveatc.net/klax4', bbox: [[33.7, -118.5], [34.0, -118.3]] }
            },
            COLORS: {
                COMM: '#a8c256', 
                GA: '#6b9b37',   
                MIL: '#f1f8e9',  
                HELI: '#8ba876', 
                OTHER: '#3d5e4a', 
            }
        };
        
        const AIRCRAFT_TYPES = {
            "B737": "Boeing 737-700", "B738": "Boeing 737-800", "B739": "Boeing 737-900", "B38M": "Boeing 737 MAX 8", "B39M": "Boeing 737 MAX 9",
            "B772": "Boeing 777-200", "B77W": "Boeing 777-300ER", "B788": "Boeing 787-8", "B789": "Boeing 787-9", "B744": "Boeing 747-400",
            "A319": "Airbus A319", "A320": "Airbus A320", "A20N": "Airbus A320neo", "A321": "Airbus A321", "A21N": "Airbus A321neo",
            "A332": "Airbus A330-200", "A333": "Airbus A330-300", "A359": "Airbus A350-900", "A388": "Airbus A380",
            "E170": "Embraer 170", "E175": "Embraer 175", "E190": "Embraer 190", "CRJ2": "CRJ-200", "CRJ7": "CRJ-700", "CRJ9": "CRJ-900",
            "C172": "Cessna 172", "SR22": "Cirrus SR22", "PC12": "Pilatus PC-12", "C208": "Cessna Caravan"
        };

        const state = {
            location: 'JFK', map: null, isRadarOn: true, selectedItem: null, isFollowing: false,
            audioElement: document.getElementById('audio')
        };
        const layers = {
            base: null, radar: null,
            planes: { markers: new Map(), trails: new Map(), lines: new Map(), data: new Map() },
            overlays: [], reticle: null
        };

        function init() {
            updateLocationTitle();
            initMap();
            if(state.isRadarOn) initializeRadarOn();
            startTracking();
            setupEventListeners();
            updateClock(); setInterval(updateClock, 1000);
            autoStartAudio();
            setupCustomDropdown();
        }

        function initMap() {
            const loc = CONFIG.LOCATIONS[state.location];
            state.map = L.map('map', { center: [loc.viewLat||loc.lat, loc.viewLon||loc.lon], zoom: loc.zoom, zoomControl: false, attributionControl: false });
            layers.base = L.tileLayer(CONFIG.URLS.MAP, { attribution: '© OpenStreetMap', maxZoom: 19, className: 'map-tiles' }).addTo(state.map);
            layers.radar = L.tileLayer(CONFIG.URLS.RADAR, { opacity: 0.5, zIndex: 500, className: 'radar-tiles' });
            updateLocationMarker();
            L.control.zoom({ position: 'bottomright' }).addTo(state.map);
        }
        function initializeRadarOn() { layers.radar.addTo(state.map); document.getElementById('radar-control').classList.add('active'); }

        function setupEventListeners() {
            document.getElementById('audio-control').addEventListener('click', toggleAudio);
            document.getElementById('radar-control').addEventListener('click', toggleRadar);
            document.getElementById('recenter-btn').addEventListener('click', recenterView);
            
            state.map.on('click', (e) => {
                if (e.originalEvent.target.closest('.leaflet-marker-icon')) return;
                
                const wasFollowing = state.isFollowing || state.selectedItem;
                if (wasFollowing) {
                    recenterView(); // Clears everything and resets view
                }

                if (state.audioElement.paused) {
                    state.audioElement.muted = false;
                    state.audioElement.play().then(()=>{ 
                        document.getElementById('audio-control').classList.add('playing'); 
                        document.getElementById('audio-text').textContent='ATC LIVE'; 
                    }).catch(()=>{});
                }
            });
        }

        function setupCustomDropdown() {
            const wrapper = document.querySelector('.custom-select-wrapper');
            const select = wrapper.querySelector('.custom-select');
            const trigger = wrapper.querySelector('.custom-select__trigger');
            const options = wrapper.querySelectorAll('.custom-option');
            const selectedText = document.getElementById('selected-text');

            trigger.addEventListener('click', (e) => {
                select.classList.toggle('open');
                e.stopPropagation(); 
            });

            options.forEach(option => {
                option.addEventListener('click', function() {
                    wrapper.querySelector('.custom-option.selected').classList.remove('selected');
                    this.classList.add('selected');
                    selectedText.textContent = this.textContent;
                    select.classList.remove('open');
                    const value = this.getAttribute('data-value');
                    changeLocation(value); 
                });
            });

            window.addEventListener('click', (e) => {
                if (!select.contains(e.target)) {
                    select.classList.remove('open');
                }
            });
        }

        function recenterView() {
            state.isFollowing = false; 
            state.selectedItem = null; 
            const loc = CONFIG.LOCATIONS[state.location];
            state.map.setView([loc.viewLat||loc.lat, loc.viewLon||loc.lon], loc.zoom);
            hideInfoBox();
        }

        function changeLocation(code) {
            state.isFollowing = false; state.location = code;
            const loc = CONFIG.LOCATIONS[code];
            updateLocationTitle();
            state.map.setView([loc.viewLat||loc.lat, loc.viewLon||loc.lon], loc.zoom);
            updateLocationMarker(); clearMapData(); hideInfoBox();
            handleAudioChange(loc.audio);
            if(state.isRadarOn) layers.radar.addTo(state.map);
        }
        function updateLocationMarker() {
            layers.overlays.forEach(l=>state.map.removeLayer(l)); layers.overlays=[];
            if(state.location!=='DC') {
                layers.overlays.push(L.marker([CONFIG.LOCATIONS[state.location].lat, CONFIG.LOCATIONS[state.location].lon], {icon:createLocationIcon(CONFIG.LOCATIONS[state.location].name)}).addTo(state.map));
            } else {
                layers.overlays.push(L.marker([38.9531, -77.4565], {icon:createLocationIcon('IAD')}).addTo(state.map));
                layers.overlays.push(L.marker([38.8521, -77.0377], {icon:createLocationIcon('DCA')}).addTo(state.map));
            }
        }
        function clearMapData() {
            layers.planes.markers.forEach(m=>state.map.removeLayer(m));
            layers.planes.markers.clear();
            if(layers.planes.lines){ layers.planes.lines.forEach(l=>state.map.removeLayer(l)); layers.planes.lines.clear(); }
            if(layers.planes.trails) layers.planes.trails.clear();
            layers.planes.data.clear();
            
            if(layers.reticle) { state.map.removeLayer(layers.reticle); layers.reticle=null; }
            updateStats();
        }

        async function fetchPlanes() {
            try {
                const l = CONFIG.LOCATIONS[state.location];
                const res = await fetch(CONFIG.URLS.ADSB(l.lat, l.lon));
                const data = await res.json();
                if(!data.ac) return;
                const active = new Set();
                data.ac.forEach(ac => {
                    if(!ac.lat || !ac.lon) return;
                    active.add(ac.hex);
                    
                    const old = layers.planes.data.get(ac.hex);
                    let bank=0; if(old && old.track!==undefined && ac.track!==undefined) {
                        let d = ac.track - old.track; if(d>180)d-=360; if(d<-180)d+=360;
                        bank = Math.max(-45, Math.min(45, d*2.5));
                    }
                    ac.pseudoBank = bank;
                    
                    let pitch=0; const gs = ac.gs||0; const vs = ac.baro_rate||0;
                    if(gs>30) pitch = Math.max(-20, Math.min(20, Math.atan((vs/101.3)/gs)*(180/Math.PI)));
                    ac.pseudoPitch = pitch;
                    
                    layers.planes.data.set(ac.hex, ac);
                    
                    if(!layers.planes.trails.has(ac.hex)) layers.planes.trails.set(ac.hex,[]);
                    const t = layers.planes.trails.get(ac.hex); t.push([ac.lat,ac.lon]); if(t.length>100)t.shift();

                    updatePlaneMarker(ac, t);
                    if(state.selectedItem===ac.hex && state.isFollowing) {
                        updateHUD(ac);
                    }
                });
                layers.planes.markers.forEach((_,h)=>{
                    if(!active.has(h)) {
                        state.map.removeLayer(layers.planes.markers.get(h)); layers.planes.markers.delete(h);
                        if(layers.planes.lines.has(h)) { state.map.removeLayer(layers.planes.lines.get(h)); layers.planes.lines.delete(h); }
                        layers.planes.trails.delete(h);
                    }
                });
                updateStats();
            } catch(e){}
        }

        function updatePlaneMarker(ac, trail) {
            if(state.selectedItem===ac.hex && state.isFollowing) {
                state.map.panTo([ac.lat,ac.lon]);
                if(layers.reticle) layers.reticle.setLatLng([ac.lat,ac.lon]);
            }
            let col=CONFIG.COLORS.OTHER, type='other';
            if(ac.category==='A7'){type='heli';col=CONFIG.COLORS.HELI;}
            else if(['A3','A4','A5'].includes(ac.category)){type='comm';col=CONFIG.COLORS.COMM;}
            else if(['A1','A2'].includes(ac.category)){type='ga';col=CONFIG.COLORS.GA;}
            else if(ac.category==='A6'){type='mil';col=CONFIG.COLORS.MIL;}
            
            const icon = createHudIcon(type, ac.track||0, col, type==='heli');
            if(layers.planes.markers.has(ac.hex)) layers.planes.markers.get(ac.hex).setLatLng([ac.lat,ac.lon]).setIcon(icon);
            else {
                const m = L.marker([ac.lat,ac.lon],{icon}).addTo(state.map);
                m.on('click', ()=>{
                    const d=layers.planes.data.get(ac.hex);
                    showInfo('plane', d); createReticle(d.lat,d.lon);
                });
                layers.planes.markers.set(ac.hex, m);
            }
            updateTrailLine(layers.planes.lines, ac.hex, trail, col);
        }

        function createReticle(lat, lon) {
            if(layers.reticle) { state.map.removeLayer(layers.reticle); layers.reticle=null; }
            const icon = L.divIcon({className:'target-reticle-icon', html:'<div class="reticle-ring"></div>', iconSize:[60,60], iconAnchor:[30,30]});
            layers.reticle = L.marker([lat,lon],{icon, zIndexOffset:1000}).addTo(state.map);
        }

        function createLocationIcon(l) { 
            return L.divIcon({
                className:'', 
                html:`<div style="background:#a8c256; color:#0d1f19; font-weight:700; font-size:10px; padding:2px 6px; border-radius:4px; white-space:nowrap; width:max-content; transform:translate(-50%, -20px); text-align:center; box-shadow:0 2px 4px rgba(0,0,0,0.6); border:1px solid #0d1f19;">${l}</div><div style="width:12px; height:12px; background:#a8c256; border:2px solid #0d1f19; border-radius:50%; box-shadow:0 0 5px rgba(168,194,86,0.5);"></div>`, 
                iconSize:[0,0], 
                iconAnchor:[6,6]
            }); 
        }
        
        function createHudIcon(t,r,c,h,p=CONFIG.PATHS.PLANE) { const html=h?`<span style="color:${c};transform:rotate(${r}deg);display:inline-block;font-size:24px; text-shadow:0 1px 2px rgba(0,0,0,0.5);">&infin;</span>`:`<svg width="24" height="24" viewBox="0 0 24 24" style="transform:rotate(${r}deg);filter:drop-shadow(0 1px 2px rgba(0,0,0,0.5));"><path fill="${c}" d="${p}"/></svg>`; return L.divIcon({className:'marker-icon', html, iconSize:[24,24], iconAnchor:[12,12]}); }
        function updateTrailLine(m,i,t,c) { if(t.length<2)return; if(m.has(i)) m.get(i).setLatLngs(t).setStyle({color:c, opacity:0.5, weight:2}); else m.set(i, L.polyline(t,{color:c, opacity:0.5, weight:2}).addTo(state.map)); }

        const routeCache = new Map();

        async function fetchRoute(callsign) {
            const depEl = document.getElementById('ac-route-dep');
            const arrEl = document.getElementById('ac-route-arr');

            if (!callsign) return;

            if (routeCache.has(callsign)) {
                const data = routeCache.get(callsign);
                if (data !== "PENDING") updateRouteUI(data.dep, data.arr);
                return;
            }

            routeCache.set(callsign, "PENDING");
            depEl.textContent = "???";
            arrEl.textContent = "???";
            depEl.style.opacity = "0.5";
            arrEl.style.opacity = "0.5";

            try {
                const url = `${CONFIG.URLS.AWS_PROXY}?callsign=${callsign.trim()}`;
                const res = await fetch(url);
                
                if (!res.ok) {
                     routeCache.set(callsign, { dep: "---", arr: "---" });
                     updateRouteUI("---", "---");
                     return;
                }

                const json = await res.json();

                if (json.flights && json.flights.length > 0) {
                    let flight = json.flights.find(f => !f.actual_on) || json.flights[0];
                    const dep = flight.origin ? flight.origin.code_iata : "UNK";
                    const arr = flight.destination ? flight.destination.code_iata : "UNK";
                    routeCache.set(callsign, { dep, arr });
                    updateRouteUI(dep, arr);
                } else {
                    routeCache.set(callsign, { dep: "---", arr: "---" });
                    updateRouteUI("---", "---");
                }
            } catch (e) {
                routeCache.set(callsign, { dep: "---", arr: "---" });
                updateRouteUI("---", "---");
            }
        }

        function updateRouteUI(dep, arr) {
            const depEl = document.getElementById('ac-route-dep');
            const arrEl = document.getElementById('ac-route-arr');
            
            depEl.textContent = dep;
            arrEl.textContent = arr;
            depEl.style.opacity = "1";
            arrEl.style.opacity = "1";
        }

        function updateHUD(data) {
            document.getElementById('ac-alt').textContent = (data.alt_baro||0).toLocaleString() + ' ft';
            document.getElementById('ac-spd').textContent = Math.round((data.gs||0)*1.15) + ' mph';
            
            const vs = data.baro_rate || 0; 
            const alt = typeof data.alt_baro === 'number' ? data.alt_baro : 0;
            let status = "CRUISING";

            if(data.alt_baro === "ground") {
                status = "TAXI/GND";
            } else if (vs > 300) {
                status = alt < 2000 ? "TAKEOFF" : "CLIMBING";
            } else if (vs < -300) {
                if (alt < 800) status = "LANDING";
                else if (alt < 4000) status = "APPROACH";
                else status = "DESCENDING";
            }
            document.getElementById('ac-stat').textContent = status;
            updateAHRSDisplay(data);
        }

        function showInfo(type, data) {
            state.selectedItem = data.hex || data.mmsi || data.incident_number; state.isFollowing = true;
            document.getElementById('aircraft-info').style.display='none';
            
            if(type==='plane') {
                document.getElementById('ac-callsign').textContent = data.flight?.trim() || data.hex;
                const rawType = data.t || 'UNK';
                document.getElementById('ac-type').textContent = AIRCRAFT_TYPES[rawType] || rawType;
                
                document.getElementById('ac-reg').textContent = data.r || ''; 
                fetchRoute(data.flight ? data.flight.trim() : null);
                
                updateHUD(data);
                
                document.getElementById('ahrs-full-display').style.display='block';
                document.getElementById('aircraft-info').style.display='block';
                state.map.flyTo([data.lat,data.lon], 11, {duration:0.8});
            }
            document.getElementById('info-panel').classList.add('visible');
        }

        function hideInfoBox() {
            state.isFollowing = false; 
            state.selectedItem = null; 
            document.getElementById('info-panel').classList.remove('visible');
            if(layers.reticle) { state.map.removeLayer(layers.reticle); layers.reticle=null; }
        }

        function updateAHRSDisplay(data) {
            const bank = data.pseudoBank||0; const pitch = data.pseudoPitch||0;
            const horizon = document.getElementById('ahrs-horizon');
            if(horizon) horizon.style.transform = `rotate(${-bank}deg) translateY(${pitch*4}px)`;
            const hdg = data.track || 0;
            document.getElementById('ac-hdg-text').textContent = Math.round(hdg).toString().padStart(3,'0') + '°';
        }

        function toggleRadar() { state.isRadarOn=!state.isRadarOn; const b=document.getElementById('radar-control'); if(state.isRadarOn){layers.radar.addTo(state.map);b.classList.add('active');b.textContent='RADAR: ON';}else{layers.radar.remove();b.classList.remove('active');b.textContent='RADAR: OFF';} }
        function toggleAudio() { if(state.audioElement.paused){state.audioElement.play();document.getElementById('audio-control').classList.add('playing');document.getElementById('audio-text').textContent='ATC LIVE';}else{state.audioElement.pause();document.getElementById('audio-control').classList.remove('playing');document.getElementById('audio-text').textContent='ATC OFFLINE';} }
        function handleAudioChange(u) { const p=!state.audioElement.paused; state.audioElement.src=u; if(p)state.audioElement.play().catch(()=>{}); else {document.getElementById('audio-control').classList.remove('playing');document.getElementById('audio-text').textContent='ATC OFFLINE';} }
        function autoStartAudio() { state.audioElement.src=CONFIG.LOCATIONS[state.location].audio; state.audioElement.muted=true; state.audioElement.play().then(()=>{setTimeout(()=>{state.audioElement.muted=false;document.getElementById('audio-text').textContent='ATC LIVE';},500);document.getElementById('audio-control').classList.add('playing');}).catch(()=>{}); }
        
        function updateLocationTitle() { document.getElementById('location-title').textContent = CONFIG.LOCATIONS[state.location].name; }
        function updateStats() { document.getElementById('aircraft-count').textContent=layers.planes.data.size; }
        function updateClock() { const d=new Date(); document.getElementById('current-time').textContent=`${d.getHours().toString().padStart(2,'0')}:${d.getMinutes().toString().padStart(2,'0')}:${d.getSeconds().toString().padStart(2,'0')}`; }
        
        function startTracking() { fetchPlanes(); setInterval(fetchPlanes,3000); }
        
        init();
    </script>
</body>
</html>